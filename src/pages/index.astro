---
import { getCollection } from "astro:content";
import Layout from "../layouts/Layout.astro";
import {
  calculateMonthlyData,
  analyzeExpensesByCategory,
  analyzeContributions,
  analyzeMonthlyRecurringContributions,
  analyzeSalariedExpenses,
  calculateRunwayProjection,
  calculateSalaryPercentageOfIncome,
  getTopContributors,
  getTopExpenses,
  getLargestOneTimeContributions,
} from "../lib/analysis";

const transactionsCollection = await getCollection("transactions");
const transactions = transactionsCollection.map((t) => t.data);

const monthlyData = calculateMonthlyData(transactions);
const expensesByCategory = analyzeExpensesByCategory(transactions);
const contributions = analyzeContributions(transactions);
const monthlyContributions = analyzeMonthlyRecurringContributions(transactions);
const salariedExpenses = analyzeSalariedExpenses(transactions);
const runway = calculateRunwayProjection(transactions);
const salaryAnalysis = calculateSalaryPercentageOfIncome(transactions);
const topContributors = getTopContributors(transactions, 15);
const topExpenses = getTopExpenses(transactions, 15);
const largestOneTime = getLargestOneTimeContributions(transactions, 5);

const formatCurrency = (amount: number) =>
  new Intl.NumberFormat("en-US", { style: "currency", currency: "USD" }).format(amount);

const totalIncome = monthlyData.reduce((sum, m) => sum + m.income, 0);
const totalExpenses = monthlyData.reduce((sum, m) => sum + m.expenses, 0);
---

<Layout title="Astro OpenCollective Budget Analysis">
  <section class="hero-section">
    <div class="hero-left">
      <div class="summary-cards">
        <div class="card highlight current-balance">
          <h3>Current Balance</h3>
          <p class="value" class:list={{ positive: runway.currentBalance > 0, negative: runway.currentBalance < 0 }}>
            {formatCurrency(runway.currentBalance)}
          </p>
        </div>
        <div class="card">
          <h3>Avg Monthly Income</h3>
          <p class="value positive">{formatCurrency(runway.averageMonthlyIncome)}</p>
        </div>
        <div class="card">
          <h3>Avg Monthly Expenses</h3>
          <p class="value negative">{formatCurrency(runway.averageMonthlyExpenses)}</p>
        </div>
        <div class="card">
          <h3>Avg Monthly Diff</h3>
          <p class="value" class:list={{ positive: runway.averageMonthlyNet > 0, negative: runway.averageMonthlyNet < 0 }}>
            {formatCurrency(runway.averageMonthlyNet)}
          </p>
        </div>
        <div class="card">
          <h3>All-Time Income</h3>
          <p class="value positive">{formatCurrency(totalIncome)}</p>
        </div>
        <div class="card">
          <h3>All-Time Expenses</h3>
          <p class="value negative">{formatCurrency(totalExpenses)}</p>
        </div>
        <div class="card highlight">
          <h3>Runway</h3>
          <p class="value" class:list={{ warning: runway.monthsOfRunway < 12 && runway.monthsOfRunway !== Infinity }}>
            {runway.monthsOfRunway === Infinity ? "Sustainable" : `${runway.monthsOfRunway} months`}
          </p>
        </div>
      </div>
      <p class="hero-note">
        {transactions.length.toLocaleString()} transactions from {monthlyData[0]?.month} to {monthlyData[monthlyData.length - 1]?.month}.
        Figures differ from Open Collective dashboard, which excludes host fees (~10%) from totals.
      </p>
    </div>
    <div class="chart-section expense-chart">
      <h2>Expense Categories</h2>
      <p class="note category-note">
        <strong>Paid Maintainers:</strong> Consultant fees and core maintainer stipends.
        <strong>Community Incentives:</strong> Grants, awards, and community support.
        <strong>Miscellaneous:</strong> Travel, donations, and uncategorized expenses.
        <strong>OpenCollective Fees:</strong> Platform hosting fees (~10%).
      </p>
      <div class="chart-container small">
        <canvas id="expenseCategoryChart"></canvas>
      </div>
    </div>
  </section>

  <section class="chart-section">
    <h2>Monthly Income vs Expenses</h2>
    <div class="chart-container">
      <canvas id="monthlyChart"></canvas>
    </div>
  </section>

  <section class="chart-section">
    <h2>Cumulative Balance Over Time</h2>
    <div class="chart-container">
      <canvas id="balanceChart"></canvas>
    </div>
  </section>

  <section class="chart-section">
    <h2>Recurring vs One-Time Contributions</h2>
    <div class="stats-row">
      <div class="stat">
        <span class="stat-label">Recurring Total</span>
        <span class="stat-value positive">{formatCurrency(contributions.recurring.amount)}</span>
        <span class="stat-count">({contributions.recurring.count} contributions)</span>
      </div>
      <div class="stat">
        <span class="stat-label">One-Time Total</span>
        <span class="stat-value">{formatCurrency(contributions.oneTime.amount)}</span>
        <span class="stat-count">({contributions.oneTime.count} contributions)</span>
      </div>
    </div>
    <p class="note">
      Classification is based on OpenCollective's transaction descriptions: contributions labeled
      "Monthly contribution from..." are counted as recurring; all others (including "Contribution from...",
      "Added Funds from GitHub Sponsors", etc.) are counted as one-time. GitHub Sponsors contributions
      arrive as periodic lump-sum transfers and cannot be distinguished as recurring vs one-time from
      this data alone.
    </p>
    <div class="chart-container small">
      <canvas id="contributionTypeChart"></canvas>
    </div>
  </section>

  <section class="chart-section">
    <h2>Paid Maintainers Analysis</h2>
    <p class="note">
      Recurring stipend payments only. One-time payments (bonuses, contract work) are not included in these figures.
    </p>
    <p class="salary-total-line">
      Combined maintainer stipends account for
      <strong class:list={{ warning: salaryAnalysis.percentageOfTotalIncome > 100 }}>
        {salaryAnalysis.percentageOfTotalIncome}%
      </strong>
      of average monthly income.
    </p>
    <div class="table-container">
      <table class="maintainers-table">
        <thead>
          <tr>
            <th>Recipient</th>
            <th class="number">Total Paid</th>
            <th class="number">Monthly Avg</th>
            <th class="number">% of Income</th>
            <th class="number">Count</th>
            <th class="number">First</th>
            <th class="number">Last</th>
          </tr>
        </thead>
        <tbody>
          {salariedExpenses.filter((s) => s.paymentCount > 1).map((s) => {
            const percentOfIncome = salaryAnalysis.avgMonthlyIncome > 0
              ? Math.round((s.monthlyAverage / salaryAnalysis.avgMonthlyIncome) * 1000) / 10
              : 0;
            return (
              <tr>
                <td>{s.recipient}</td>
                <td class="number">{formatCurrency(s.totalPaid)}</td>
                <td class="number">{formatCurrency(s.monthlyAverage)}</td>
                <td class="number">{percentOfIncome}%</td>
                <td class="number">{s.paymentCount}</td>
                <td class="number">{s.firstPayment}</td>
                <td class="number">{s.lastPayment}</td>
              </tr>
            );
          })}
        </tbody>
      </table>
    </div>
  </section>

  <section class="two-column">
    <div class="chart-section">
      <h2>Top Contributors</h2>
      <div class="table-container">
        <table class="expandable-table" data-visible="5">
          <thead>
            <tr>
              <th>Contributor</th>
              <th class="number">Total</th>
              <th class="number">Count</th>
            </tr>
          </thead>
          <tbody>
            {topContributors.map((c, i) => (
              <tr class:list={{ hidden: i >= 5 }}>
                <td>{c.source}</td>
                <td class="number positive">{formatCurrency(c.amount)}</td>
                <td class="number">{c.count}</td>
              </tr>
            ))}
          </tbody>
        </table>
        {topContributors.length > 5 && (
          <button class="expand-toggle" aria-expanded="false">Show More</button>
        )}
      </div>
    </div>

    <div class="chart-section">
      <h2>Top Recipients</h2>
      <div class="table-container">
        <table class="expandable-table" data-visible="5">
          <thead>
            <tr>
              <th>Recipient</th>
              <th class="number">Total</th>
              <th class="number">Count</th>
            </tr>
          </thead>
          <tbody>
            {topExpenses.map((e, i) => (
              <tr class:list={{ hidden: i >= 5 }}>
                <td>{e.recipient}</td>
                <td class="number negative">{formatCurrency(e.amount)}</td>
                <td class="number">{e.count}</td>
              </tr>
            ))}
          </tbody>
        </table>
        {topExpenses.length > 5 && (
          <button class="expand-toggle" aria-expanded="false">Show More</button>
        )}
      </div>
    </div>
  </section>

  <section class="chart-section">
    <h2>Largest One-Time Contributions</h2>
    <p class="note">Single transactions that are not labeled as "Monthly contribution"</p>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Source</th>
            <th class="number">Amount</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          {largestOneTime.map((c) => (
            <tr>
              <td class="date">{c.date}</td>
              <td>{c.source}</td>
              <td class="number positive">{formatCurrency(c.amount)}</td>
              <td class="description">{c.description}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </section>

</Layout>

<script type="application/json" id="chart-data" set:html={JSON.stringify({ monthlyData, expensesByCategory, monthlyContributions })} />

<script>
  import Chart from "chart.js/auto";

  const dataElement = document.getElementById("chart-data");
  const { monthlyData, expensesByCategory, monthlyContributions } = JSON.parse(dataElement?.textContent || "{}");

  const colors = {
    green: "#3fb950",
    red: "#f85149",
    blue: "#58a6ff",
    purple: "#a371f7",
    yellow: "#d29922",
    cyan: "#39c5cf",
    orange: "#f0883e",
    pink: "#db61a2",
  };

  const chartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        labels: { color: "#c9d1d9" },
      },
    },
    scales: {
      x: {
        ticks: { color: "#8b949e" },
        grid: { color: "#30363d" },
      },
      y: {
        ticks: { color: "#8b949e" },
        grid: { color: "#30363d" },
      },
    },
  };

  new Chart(document.getElementById("monthlyChart") as HTMLCanvasElement, {
    type: "bar",
    data: {
      labels: monthlyData.map((d: any) => d.month),
      datasets: [
        {
          label: "Income",
          data: monthlyData.map((d: any) => d.income),
          backgroundColor: colors.green,
        },
        {
          label: "Expenses",
          data: monthlyData.map((d: any) => -d.expenses),
          backgroundColor: colors.red,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (context: any) => {
              const value = Math.abs(context.raw);
              const formatted = new Intl.NumberFormat("en-US", { style: "currency", currency: "USD" }).format(value);
              return `${context.dataset.label}: ${formatted}`;
            },
          },
        },
      },
      scales: {
        x: {
          ticks: { color: "#8b949e" },
          grid: { color: "#30363d" },
        },
        y: {
          ticks: {
            color: "#8b949e",
            callback: (value: any) => {
              if (Math.abs(value) >= 1000) return (value / 1000).toFixed(0) + "k";
              return value;
            },
          },
          grid: { color: "#30363d" },
        },
      },
    },
  });

  let cumulative = 0;
  const cumulativeData = monthlyData.map((d: any) => {
    cumulative += d.net;
    return cumulative;
  });

  new Chart(document.getElementById("balanceChart") as HTMLCanvasElement, {
    type: "line",
    data: {
      labels: monthlyData.map((d: any) => d.month),
      datasets: [
        {
          data: cumulativeData,
          borderColor: colors.blue,
          backgroundColor: colors.blue + "33",
          fill: true,
          tension: 0.1,
        },
      ],
    },
    options: {
      ...chartOptions,
      plugins: { ...chartOptions.plugins, legend: { display: false } },
    },
  });

  new Chart(document.getElementById("contributionTypeChart") as HTMLCanvasElement, {
    type: "line",
    data: {
      labels: monthlyContributions.map((d: any) => d.month),
      datasets: [
        {
          label: "Recurring",
          data: monthlyContributions.map((d: any) => d.recurring),
          borderColor: colors.green,
          backgroundColor: colors.green + "33",
          fill: true,
        },
        {
          label: "One-Time",
          data: monthlyContributions.map((d: any) => d.oneTime),
          borderColor: colors.purple,
          backgroundColor: colors.purple + "33",
          fill: true,
        },
      ],
    },
    options: chartOptions,
  });

  const topCategories = expensesByCategory.slice(0, 8);
  const categoryColorMap: Record<string, string> = {
    "Paid Maintainers": "#58a6ff",      // Blue - primary expense, professional
    "Community Incentives": "#a371f7",  // Purple - community/creative
    "OpenCollective Fees": "#6e7681",   // Gray - overhead/platform fees
    "Miscellaneous": "#f0883e",         // Orange - varied/other
  };
  const fallbackColors = [colors.cyan, colors.pink, colors.yellow, colors.green];

  new Chart(document.getElementById("expenseCategoryChart") as HTMLCanvasElement, {
    type: "doughnut",
    data: {
      labels: topCategories.map((c: any) => c.source),
      datasets: [
        {
          data: topCategories.map((c: any) => c.amount),
          backgroundColor: topCategories.map((c: any, i: number) =>
            categoryColorMap[c.source] || fallbackColors[i % fallbackColors.length]
          ),
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: "right",
          labels: { color: "#c9d1d9", font: { size: 14 } },
        },
        tooltip: {
          callbacks: {
            label: (context: any) => {
              const value = context.raw;
              const total = context.dataset.data.reduce((sum: number, val: number) => sum + val, 0);
              const percentage = ((value / total) * 100).toFixed(1);
              const formatted = new Intl.NumberFormat("en-US", { style: "currency", currency: "USD" }).format(value);
              return `${formatted} (${percentage}%)`;
            },
          },
        },
      },
    },
  });

  // Expandable table toggles
  document.querySelectorAll(".expand-toggle").forEach((button) => {
    const container = button.closest(".table-container");
    const table = container?.querySelector(".expandable-table");
    const visibleCount = parseInt(table?.getAttribute("data-visible") || "5", 10);
    const allRows = table?.querySelectorAll("tbody tr");

    button.addEventListener("click", () => {
      const isExpanded = button.getAttribute("aria-expanded") === "true";

      allRows?.forEach((row, i) => {
        if (i >= visibleCount) {
          row.classList.toggle("hidden", isExpanded);
        }
      });

      button.setAttribute("aria-expanded", String(!isExpanded));
      button.textContent = isExpanded ? "Show More" : "Show Less";
    });
  });

</script>

<style>
  .hero-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-bottom: 2rem;
  }

  .hero-left {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .hero-section .summary-cards {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    align-content: start;
  }

  .hero-section .summary-cards .current-balance {
    grid-column: span 2;
  }

  .hero-section .summary-cards .current-balance .value {
    font-size: 2rem;
  }

  .hero-note {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    font-style: italic;
    line-height: 1.5;
    margin: 0;
  }

  .hero-section .expense-chart {
    margin-bottom: 0;
  }

  .hero-section .expense-chart .chart-container.small {
    height: 350px;
  }

  @media (max-width: 800px) {
    .hero-section {
      grid-template-columns: 1fr;
    }
  }

  .summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
  }

  .card.highlight {
    border-color: var(--color-accent);
  }

  .card h3 {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
  }

  .card .value {
    font-size: 1.25rem;
    font-weight: 600;
  }

  .positive {
    color: var(--color-green);
  }

  .negative {
    color: var(--color-red);
  }

  .warning {
    color: var(--color-yellow);
  }

  .chart-section {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 2rem;
  }

  .chart-container {
    height: 400px;
    position: relative;
  }

  .chart-container.small {
    height: 300px;
  }


  .two-column {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 2rem;
    margin-bottom: 2rem;
  }

  .two-column .chart-section {
    margin-bottom: 0;
  }

  .stats-row {
    display: flex;
    gap: 2rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }

  .stat {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .stat-label {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    text-transform: uppercase;
  }

  .stat-value {
    font-size: 1.25rem;
    font-weight: 600;
  }

  .stat-count {
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  .salary-total-line {
    font-size: 1rem;
    margin-bottom: 1.5rem;
  }

  .salary-total-line strong {
    font-size: 1.25rem;
  }

  .note {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-bottom: 1.5rem;
    font-style: italic;
  }

  .category-note {
    font-size: 0.75rem;
    line-height: 1.5;
  }

  .category-note strong {
    color: var(--color-text);
    font-style: normal;
  }

  .table-container {
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
  }

  th,
  td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--color-border);
  }

  th {
    font-weight: 600;
    color: var(--color-text-muted);
    font-size: 0.75rem;
    text-transform: uppercase;
  }

  .number {
    font-family: monospace;
    white-space: nowrap;
  }



  td.date {
    white-space: nowrap;
    font-family: monospace;
    color: var(--color-text-muted);
  }

  td.description {
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    color: var(--color-text-muted);
    font-size: 0.75rem;
  }

  tr.hidden {
    display: none;
  }

  .expand-toggle {
    width: 100%;
    margin-top: 0.5rem;
    padding: 0.5rem;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    color: var(--color-accent);
    font-size: 0.75rem;
    cursor: pointer;
    transition: background-color 0.15s;
  }

  .expand-toggle:hover {
    background: var(--color-border);
  }
</style>
